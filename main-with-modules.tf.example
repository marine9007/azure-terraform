# Example of using modules - rename to main.tf to use
# This shows how to expand the configuration using modules

# Random suffix for unique names
resource "random_string" "suffix" {
  length  = 6
  special = false
  upper   = false
}

locals {
  suffix = random_string.suffix.result
  common_tags = merge(
    var.tags,
    {
      Environment = var.environment
      Location    = var.location
    }
  )
}

# Resource Group
resource "azurerm_resource_group" "main" {
  name     = var.resource_group_name
  location = var.location
  tags     = local.common_tags
}

# Storage Module with version constraint
module "storage" {
  source  = "./modules/storage"
  
  # Version constraint (if using Terraform Registry or git with tags)
  # version = "~> 1.0"
  
  storage_account_name = "st${local.suffix}"
  resource_group_name  = azurerm_resource_group.main.name
  location             = azurerm_resource_group.main.location
  account_tier         = var.storage_account_tier
  replication_type     = var.storage_account_replication
  
  enable_static_website = true
  
  containers = {
    content = {
      access_type = "private"
    }
    backups = {
      access_type = "private"
    }
  }
  
  tags = local.common_tags
}

# You could add more modules here:
# module "app_service" {
#   source  = "./modules/app-service"
#   version = "~> 1.0"
#   ...
# }

# module "networking" {
#   source  = "./modules/networking"
#   version = "~> 2.0"
#   ...
# }

# App Service Plan (F1 Free tier)
resource "azurerm_service_plan" "main" {
  name                = "plan-${var.environment}-${local.suffix}"
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_resource_group.main.location
  os_type             = "Linux"
  sku_name            = "F1"

  tags = local.common_tags
}

# App Service
resource "azurerm_linux_web_app" "main" {
  name                = coalesce(var.app_service_name, "app-${var.environment}-${local.suffix}")
  resource_group_name = azurerm_resource_group.main.name
  location            = azurerm_service_plan.main.location
  service_plan_id     = azurerm_service_plan.main.id

  site_config {
    always_on = false
    
    application_stack {
      node_version = "18-lts"
    }
  }

  tags = local.common_tags
}

